# --- Duration Calculation (Safe HH:mm:ss) ---
try {
    $createdDate = $latestRun.createdDate
    $finishedDate = $latestRun.finishedDate

    if (-not $createdDate -or -not $finishedDate) {
        throw "Missing createdDate or finishedDate."
    }

    $startTime = [datetime]::Parse($createdDate.ToString())
    $endTime   = [datetime]::Parse($finishedDate.ToString())

    $duration = New-TimeSpan -Start $startTime -End $endTime

    # Format as HH:mm:ss
    $durationFormatted = '{0:00}:{1:00}:{2:00}' -f $duration.Hours, $duration.Minutes, $duration.Seconds
}
catch {
    Write-Error "❌ General error occurred while processing pipeline telemetry: Failed to calculate duration: $_"
    $durationFormatted = $null
}

Write-Host "createdDate raw: $($latestRun.createdDate)"
Write-Host "finishedDate raw: $($latestRun.finishedDate)"


try {
    $createdDate = $latestRun.createdDate
    $finishedDate = $latestRun.finishedDate

    # Handle case where it's an array
    if ($createdDate -is [System.Array]) {
        $createdDate = $createdDate[0]
    }
    if ($finishedDate -is [System.Array]) {
        $finishedDate = $finishedDate[0]
    }

    $startTime = [datetime]::Parse($createdDate.ToString())
    $endTime   = [datetime]::Parse($finishedDate.ToString())

    $duration = New-TimeSpan -Start $startTime -End $endTime
    $durationFormatted = '{0:00}:{1:00}:{2:00}' -f $duration.Hours, $duration.Minutes, $duration.Seconds
}
catch {
    Write-Error "❌ General error occurred while processing pipeline telemetry: Failed to calculate duration: $_"
    $durationFormatted = $null
}


data('azure.pipeline.execution.details')
  .filter(key='pipelineName', value='YourPipelineName')  // Optional
  .group_by(['runId', 'status', 'result'])               // Add dimensions you want
  .publish(label='Pipeline Duration by Run')

A = data("azure.pipeline.run.count", rollup="count").sum(by=["pipeline_name"])
B = A.sum(by=["pipeline_name"]).publish(label="Pipeline Runs")

